CKFinder.addPlugin("fileeditor",function(a){var j=/^(.*)\.([^\.]+)$/,k=/^(txt|css|html|htm|js|asp|cfm|cfc|ascx|php|inc|xml|xslt|xsl|cs)$/i,i=/^(css|html|htm|js|xml|xsl|php|cs)$/i,b,g,h=false,f;
var e=CKFinder.getPluginPath("fileeditor")+"codemirror/";
var d={css:e+"mode/css/css.js",js:e+"mode/javascript/javascript.js",html:[e+"mode/xml/xml.js",e+"mode/javascript/javascript.js",e+"mode/css/css.js",e+"mode/htmlmixed/htmlmixed.js"],xml:e+"mode/xml/xml.js",php:[e+"mode/xml/xml.js",e+"mode/javascript/javascript.js",e+"mode/css/css.js",e+"mode/clike/clike.js",e+"mode/php/php.js"],c:e+"mode/clike/clike.js"};
d.htm=d.html;
d.xsl=d.xml;
d.cs=d.c;
d.cpp=d.c;
var c={js:"javascript",htm:"htmlmixed",html:"htmlmixed",xsl:"xml",c:"clike",cs:"clike",cpp:"clike"};
CKFinder.dialog.add("fileEditor",function(l){var o,r;
var q=(function(){return{id:"save",label:l.lang.Fileeditor.save,type:"button",onClick:function(u){if(!h){return true
}var t=u.data.dialog;
var s=b?b.getValue():f.getById("fileContent").getValue();
l.connector.sendCommandPost("SaveFile",null,{content:s,fileName:g.name},function(v){if(v.checkError()){return false
}l.openMsgDialog("",l.lang.Fileeditor.fileSaveSuccess);
t.hide();
return undefined
},g.folder.type,g.folder);
return false
}}
})();
if(l.inPopup){r=l.document.documentElement.offsetWidth;
o=l.document.documentElement.offsetHeight
}else{var p=(l.document.parentWindow||l.document.defaultView).parent;
r=p.innerWidth?p.innerWidth:p.document.documentElement.clientWidth;
o=p.innerHeight?p.innerHeight:p.document.documentElement.clientHeight
}var n=parseInt(r,10)*0.6-10,m=parseInt(o,10)*0.7-20;
return{title:l.getSelectedFile().name,minWidth:parseInt(r,10)*0.6,minHeight:parseInt(o,10)*0.7,onHide:function(){if(h){var s=f.getById("fileContent");
if(s){s.remove()
}}},onShow:function(){var s=this;
f=s.getElement().getDocument();
var v=f.getWindow();
f.getById("fileArea").setHtml('<div class="ckfinder_loader_32" style="margin: 100px auto 0 auto;text-align:center;"><p style="height:'+m+"px;width:"+n+'px;">'+l.lang.Fileeditor.loadingFile+"</p></div>");
g=l.getSelectedFile();
var t=i.test(g.ext);
this.setTitle(g.name);
if(t&&v.$.CodeMirror===undefined){f.appendStyleSheet(e+"lib/codemirror.css")
}var u=l.connector.composeUrl("DownloadFile",{FileName:g.name,format:"text",t:new Date().getTime()},g.folder.type,g.folder);
CKFinder.ajax.load(u,function(w){if(w===null||(g.size>0&&w==="")){l.openMsgDialog("",l.lang.Fileeditor.fileOpenError);
s.hide();
return
}else{h=true
}var x=f.getById("fileArea");
x.setStyle("height","100%");
x.setHtml('<textarea id="fileContent" style="height:'+m+"px; width:"+n+'px"></textarea>');
if(CKFinder.env.opera){f.getById("fileContent").setHtml(CKFinder.tools.htmlEncode(w))
}else{f.getById("fileContent").setText(w)
}b=null;
if(t){CKFinder.scriptLoader.load(e+"lib/codemirror.js",function(){CKFinder.scriptLoader.load(d[g.ext],function(){b=v.$.CodeMirror.fromTextArea(f.getById("fileContent").$,{mode:c[g.ext]||g.ext});
var z=f.createElement("button",{attributes:{label:l.lang.common.undo}});
z.on("click",function(){b.undo()
});
z.setHtml(l.lang.common.undo);
z.appendTo(f.getById("fileArea"));
var y=f.createElement("button",{attributes:{label:l.lang.common.redo}});
y.on("click",function(){b.redo()
});
y.setHtml(l.lang.common.redo);
y.appendTo(f.getById("fileArea"))
},this,false,f.getHead())
},this,false,f.getHead())
}})
},contents:[{id:"tab1",label:"",title:"",expand:true,padding:0,elements:[{type:"html",id:"htmlLoader",html:'<style type="text/css">#fileArea .CodeMirror {background:white}#fileArea .CodeMirror-scroll {height:'+m+"px; width:"+n+"px}#fileArea .CodeMirror .cm-tab {white-space:pre;}"+(CKFinder.env.gecko&&CKFinder.env.version>=120000?"#fileArea .CodeMirror-scroll > div > div {position:absolute !important}":"")+'</style><div id="fileArea"></div>'}]}],buttons:[q,CKFinder.dialog.cancelButton]}
});
a.addFileContextMenuOption({label:a.lang.Fileeditor.contextMenuName,command:"fileEditor"},function(l,m){l.openDialog("fileEditor")
},function(l){var m=1024;
if(typeof(CKFinder.config.fileeditorMaxSize)!="undefined"){m=CKFinder.config.fileeditorMaxSize
}if(k.test(l.ext)&&l.size<=m){return l.folder.acl.fileDelete?true:-1
}return false
})
});